--[[NyaDraw Graphic Engine v1.07 for OpenOS (Minified version)
	Standalone "Screen.lua" port from MineOS
	More info on: https://github.com/Bs0Dd/OpenCompSoft/blob/master/NyaDraw/README.md
	2015-2021 - ECS: https://github.com/IgorTimofeev
	2021 - Bs0Dd: https://github.com/Bs0Dd
]]
local a=require("unicode")local b=require("computer")local c=require("bit32")local d,e;local f,g,h,i,j,k;local l,m,n,o;local p,q,r,s,t,u,v,w,x,y;local z,A,B,C,D,E=math.ceil,math.floor,math.modf,math.abs,math.min,math.max;local F,G=table.insert,table.concat;local H,I,J;local K,L=a.len,a.sub;local function M(N,O)return d*(O-1)+N end;local function P()return f,g,h end;local function Q()return i,j,k end;local function R(S,T,U,V)l,n,m,o=S,T,U,V end;local function W()l,n,m,o=1,1,d,e end;local function X()return l,n,m,o end;local Y={0x000000,0x000040,0x000080,0x0000BF,0x0000FF,0x002400,0x002440,0x002480,0x0024BF,0x0024FF,0x004900,0x004940,0x004980,0x0049BF,0x0049FF,0x006D00,0x006D40,0x006D80,0x006DBF,0x006DFF,0x009200,0x009240,0x009280,0x0092BF,0x0092FF,0x00B600,0x00B640,0x00B680,0x00B6BF,0x00B6FF,0x00DB00,0x00DB40,0x00DB80,0x00DBBF,0x00DBFF,0x00FF00,0x00FF40,0x00FF80,0x00FFBF,0x00FFFF,0x0F0F0F,0x1E1E1E,0x2D2D2D,0x330000,0x330040,0x330080,0x3300BF,0x3300FF,0x332400,0x332440,0x332480,0x3324BF,0x3324FF,0x334900,0x334940,0x334980,0x3349BF,0x3349FF,0x336D00,0x336D40,0x336D80,0x336DBF,0x336DFF,0x339200,0x339240,0x339280,0x3392BF,0x3392FF,0x33B600,0x33B640,0x33B680,0x33B6BF,0x33B6FF,0x33DB00,0x33DB40,0x33DB80,0x33DBBF,0x33DBFF,0x33FF00,0x33FF40,0x33FF80,0x33FFBF,0x33FFFF,0x3C3C3C,0x4B4B4B,0x5A5A5A,0x660000,0x660040,0x660080,0x6600BF,0x6600FF,0x662400,0x662440,0x662480,0x6624BF,0x6624FF,0x664900,0x664940,0x664980,0x6649BF,0x6649FF,0x666D00,0x666D40,0x666D80,0x666DBF,0x666DFF,0x669200,0x669240,0x669280,0x6692BF,0x6692FF,0x66B600,0x66B640,0x66B680,0x66B6BF,0x66B6FF,0x66DB00,0x66DB40,0x66DB80,0x66DBBF,0x66DBFF,0x66FF00,0x66FF40,0x66FF80,0x66FFBF,0x66FFFF,0x696969,0x787878,0x878787,0x969696,0x990000,0x990040,0x990080,0x9900BF,0x9900FF,0x992400,0x992440,0x992480,0x9924BF,0x9924FF,0x994900,0x994940,0x994980,0x9949BF,0x9949FF,0x996D00,0x996D40,0x996D80,0x996DBF,0x996DFF,0x999200,0x999240,0x999280,0x9992BF,0x9992FF,0x99B600,0x99B640,0x99B680,0x99B6BF,0x99B6FF,0x99DB00,0x99DB40,0x99DB80,0x99DBBF,0x99DBFF,0x99FF00,0x99FF40,0x99FF80,0x99FFBF,0x99FFFF,0xA5A5A5,0xB4B4B4,0xC3C3C3,0xCC0000,0xCC0040,0xCC0080,0xCC00BF,0xCC00FF,0xCC2400,0xCC2440,0xCC2480,0xCC24BF,0xCC24FF,0xCC4900,0xCC4940,0xCC4980,0xCC49BF,0xCC49FF,0xCC6D00,0xCC6D40,0xCC6D80,0xCC6DBF,0xCC6DFF,0xCC9200,0xCC9240,0xCC9280,0xCC92BF,0xCC92FF,0xCCB600,0xCCB640,0xCCB680,0xCCB6BF,0xCCB6FF,0xCCDB00,0xCCDB40,0xCCDB80,0xCCDBBF,0xCCDBFF,0xCCFF00,0xCCFF40,0xCCFF80,0xCCFFBF,0xCCFFFF,0xD2D2D2,0xE1E1E1,0xF0F0F0,0xFF0000,0xFF0040,0xFF0080,0xFF00BF,0xFF00FF,0xFF2400,0xFF2440,0xFF2480,0xFF24BF,0xFF24FF,0xFF4900,0xFF4940,0xFF4980,0xFF49BF,0xFF49FF,0xFF6D00,0xFF6D40,0xFF6D80,0xFF6DBF,0xFF6DFF,0xFF9200,0xFF9240,0xFF9280,0xFF92BF,0xFF92FF,0xFFB600,0xFFB640,0xFFB680,0xFFB6BF,0xFFB6FF,0xFFDB00,0xFFDB40,0xFFDB80,0xFFDBBF,0xFFDBFF,0xFFFF00,0xFFFF40,0xFFFF80,0xFFFFBF,0xFFFFFF}local function Z(_)return Y[_+1]end;if b.getArchitecture and b.getArchitecture()=="Lua 5.3"then H,I,J=load("return function(a)return a>>16,a>>8&0xFF,a&0xFF end,function(r,g,b)return r<<16|g<<8|b end,function(a,b,c)local d=1-c return((b>>16)*d+(a>>16)*c)//1<<16|((b>>8&0xFF)*d+(a>>8&0xFF)*c)//1<<8|((b&0xFF)*d+(a&0xFF)*c)//1 end")()else H=function(a0)local a1=a0/65536;a1=a1-a1%1;local a2=(a0-a1*65536)/256;a2=a2-a2%1;return a1,a2,a0-a1*65536-a2*256 end;I=function(a1,a2,a3)return a1*65536+a2*256+a3 end;J=function(a4,a5,a6)local a7=1-a6;local a8,a9=a4/65536,a5/65536;a8,a9=a8-a8%1,a9-a9%1;local aa,ab=(a4-a8*65536)/256,(a5-a9*65536)/256;aa,ab=aa-aa%1,ab-ab%1;local a1,a2,a3=a9*a7+a8*a6,ab*a7+aa*a6,(a5-a9*65536-ab*256)*a7+(a4-a8*65536-aa*256)*a6;return(a1-a1%1)*65536+(a2-a2%1)*256+a3-a3%1 end end;local function ac(ad,ae,...)local af=ad;local ag=table.pack(...)for ah=1,ag.n do af=ae(af,ag[ah])end;return af end;local function ai(aj)local ak={string.byte(aj:read(1))}local al=0;for ah=1,7 do if c.band(c.rshift(ak[1],8-ah),0x1)==0x0 then al=ah;break end end;for ah=1,al-2 do table.insert(ak,string.byte(aj:read(1)))end;return string.char(table.unpack(ak))end;local function am(aj,an)local ao,af={string.byte(aj:read(an)or"\x00",1,8)},0;for ah=1,#ao do af=c.bor(c.lshift(af,8),ao[ah])end;return af end;local function ap(aq,N,O,ar,as,at,au)local av=4*(aq[1]*(O-1)+N)-1;aq[av],aq[av+1],aq[av+2],aq[av+3]=ar,as,at,au;return aq end;local function aw(aj,aq,ax,ay)aq[1]=string.byte(aj:read(1))+ay;aq[2]=string.byte(aj:read(1))+ay;local az,aA,aB,aC,aD;for at=1,string.byte(aj:read(1))+ax do az=string.byte(aj:read(1))/255;for au=1,am(aj,2)+ax do aA=ai(aj)for ar=1,string.byte(aj:read(1))+ax do aB=Z(string.byte(aj:read(1)))for as=1,string.byte(aj:read(1))+ax do aC=Z(string.byte(aj:read(1)))for O=1,string.byte(aj:read(1))+ax do aD=string.byte(aj:read(1))for N=1,string.byte(aj:read(1))+ax do ap(aq,string.byte(aj:read(1))+ay,aD+ay,aB,aC,az,aA)end end end end end end end;local aE={}aE[5]=function(aj,aq)aq[1]=am(aj,2)aq[2]=am(aj,2)for ah=1,aq[1]*aq[2]do table.insert(aq,Z(string.byte(aj:read(1))))table.insert(aq,Z(string.byte(aj:read(1))))table.insert(aq,string.byte(aj:read(1))/255)table.insert(aq,ai(aj))end end;aE[6]=function(aj,aq)aw(aj,aq,0,0)end;aE[7]=function(aj,aq)aw(aj,aq,1,0)end;aE[8]=function(aj,aq)aw(aj,aq,1,1)end;local function aF(aG)local aj,aH=io.open(aG,"rb")if aj then local aI=aj:read(4)if aI=="OCIF"then local aJ=string.byte(aj:read(1))if aE[aJ]then local aq={}local af,aH=xpcall(aE[aJ],debug.traceback,aj,aq)aj:close()if af then return aq else return false,"Failed to load OCIF image: "..tostring(aH)end else aj:close()return false,"Failed to load OCIF image: encoding method \""..tostring(aJ).."\" is not supported"end else aj:close()return false,"Failed to load OCIF image: binary signature \""..tostring(aI).."\" is not valid"end else return false,"Failed to open file \""..tostring(aG).."\" for reading: "..tostring(aH)end end;local function aK(aL,aM)if not aL or not aM then aL,aM=q()end;f,g,h,i,j,k={},{},{},{},{},{}d=aL;e=aM;W()for O=1,e do for N=1,d do F(f,0x010101)F(g,0xFEFEFE)F(h," ")F(i,0x010101)F(j,0xFEFEFE)F(k," ")end end end;local function aN(aL,aM)r(aL,aM)aK(aL,aM)end;local function aO()return d,e end;local function aP()return d end;local function aQ()return e end;local function aR(aS,aT)local aU,aH=p.bind(aS,aT)if aU then if aT then aN(p.maxResolution())else aN(d,e)end else return aU,aH end end;local function aV()return p end;local function aW()w=p.get;q=p.getResolution;s=p.getBackground;t=p.getForeground;x=p.set;r=p.setResolution;u=p.setBackground;v=p.setForeground;y=p.fill end;local function aX(aY)p=aY;aW()aK()end;local function aZ(a_)if not a_ or a_>1 then a_=1 elseif a_<0.1 then a_=0.1 end;local b0,b1=component.proxy(p.getScreen()).getAspectRatio()local b2,b3=p.maxResolution()local b4=2*(16*b0-4.5)/(16*b1-4.5)local aM=a_*D(b2/b4,b2,math.sqrt(b2*b3/b4))return math.floor(aM*b4),math.floor(aM)end;local function b5(av,ar,as,au)i[av],j[av],k[av]=ar,as,au end;local function b6(av)return i[av],j[av],k[av]end;local function b7(N,O)if N>=1 and O>=1 and N<=d and O<=e then local av=d*(O-1)+N;return i[av],j[av],k[av]else return 0x000000,0x000000," "end end;local function b8(N,O,ar,as,au)if N>=l and O>=n and N<=m and O<=o then local av=d*(O-1)+N;i[av],j[av],k[av]=ar,as,au end end;local function b9(N,O,aL,aM,ar,as,au,a6)local ba;if N<l then aL=aL-l+N;N=l end;ba=N+aL-1;if ba>m then aL=aL-ba+m end;if O<n then aM=aM-n+O;O=n end;ba=O+aM-1;if ba>o then aM=aM-ba+o end;ba=d*(O-1)+N;local bb=d-aL;if a6 then for bc=1,aM do for ah=1,aL do i[ba],j[ba]=J(i[ba],ar,a6),J(j[ba],ar,a6)ba=ba+1 end;ba=ba+bb end else for bc=1,aM do for ah=1,aL do i[ba],j[ba],k[ba]=ar,as,au;ba=ba+1 end;ba=ba+bb end end end;local function bd(N,O,aL,aM,be,bf,a6)local ba;if N<l then aL=aL-l+N;N=l end;ba=N+aL-1;if ba>m then aL=aL-ba+m end;if O<n then aM=aM-n+O;O=n end;ba=O+aM-1;if ba>o then aM=aM-ba+o end;local bg,bb,bh,bi,bj,bk,bl,bm,bn,bo,a1,a2,a3=d*(O-1)+N,d-aL,{},1;ba=bg;if bf then for bc=1,aM do for ah=1,aL do bh[bi]=J(i[ba],bf,a6)ba,bi=ba+1,bi+1 end;ba=ba+bb end else for bc=1,aM do for ah=1,aL do bh[bi]=i[ba]ba,bi=ba+1,bi+1 end;ba=ba+bb end end;local bj,bk,bl,an,a1,a2,a3;for bc=1,aM do for ah=1,aL do bj,bk,bl,an=0,0,0,0;for bp=E(1,bc-be),D(bc+be,aM)do for bq=E(1,ah-be),D(ah+be,aL)do a1,a2,a3=H(bh[aL*(bp-1)+bq])bj,bk,bl,an=bj+a1,bk+a2,bl+a3,an+1 end end;a1,a2,a3=bj/an,bk/an,bl/an;a1,a2,a3=a1-a1%1,a2-a2%1,a3-a3%1;i[bg]=I(a1,a2,a3)j[bg]=0x0;k[bg]=" "bg=bg+1 end;bg=bg+bb end end;local function br(bf,a6)b9(1,1,d,e,bf or 0x0,0x000000," ",a6)end;local function bs(N,O,aL,aM)local bt,av={aL,aM}for bc=O,O+aM-1 do for ah=N,N+aL-1 do if ah>=1 and bc>=1 and ah<=d and bc<=e then av=d*(bc-1)+ah;F(bt,i[av])F(bt,j[av])F(bt,k[av])else F(bt,0x0)F(bt,0x0)F(bt," ")end end end;return bt end;local function bu(bv,bw,aq)local bx=aq[1]local bg,by,bz=d*(bw-1)+bv,3,d-bx;for O=bw,bw+aq[2]-1 do if O>=n and O<=o then for N=bv,bv+bx-1 do if N>=l and N<=m then i[bg]=aq[by]j[bg]=aq[by+1]k[bg]=aq[by+2]end;bg,by=bg+1,by+3 end;bg=bg+bz else bg,by=bg+d,by+bx*3 end end end;local function bA(S,T,U,V,bB)local bC,bD,bE,bF,bG,bH,bI=S,U,T,V,false,C(U-S),C(V-T)if bH<bI then bC,bD,bE,bF,bG,bH,bI=T,V,S,U,true,bI,bH end;if bE>bF then bE,bF=bF,bE;bC,bD=bD,bC end;local bJ,bK,bL=bE,1,bH/bI;local bM=bL;for bN=bC,bD,bC<bD and 1 or-1 do if bG then bB(bJ,bN)else bB(bN,bJ)end;bK=bK+1;if bK>bM then bJ,bM=bJ+1,bM+bL end end end;local function bO(bP,bQ,bR,bS,bB)local function bT(bU,bV)bB(bP+bU,bQ+bV)bB(bP-bU,bQ+bV)bB(bP-bU,bQ-bV)bB(bP+bU,bQ-bV)end;local N,O,bW,bX,bY,bZ,b_=bR,0,bS*bS*(1-2*bR),bR*bR,0,2*bR*bR,2*bS*bS;local c0,c1=b_*bR,0;while c0>=c1 do bT(N,O)O,c1,bY=O+1,c1+bZ,bY+bX;bX=bX+bZ;if 2*bY+bW>0 then N,c0,bY=N-1,c0-b_,bY+bW;bW=bW+b_ end end;N,O,bW,bX,bY,c0,c1=0,bS,bS*bS,bR*bR*(1-2*bS),0,0,bZ*bS;while c0<=c1 do bT(N,O)N,c0,bY=N+1,c0+b_,bY+bW;bW=bW+b_;if 2*bY+bX>0 then O,c1,bY=O-1,c1-bZ,bY+bX;bX=bX+bZ end end end;local function c2(bP,bQ,bv,bw,c3,bB)local c4=360/c3;local c5,c6=bv-bP,bw-bQ;local be=math.sqrt(c5^2+c6^2)local c7=be/2;local c8=math.deg(math.asin(c5/be))local function c9(ca)if ca>=0 then return math.floor(ca+0.5)else return math.ceil(ca-0.5)end end;local function cb(cc)local cd=math.rad(cc)local ce=math.sin(cd)*be;local cf=math.cos(cd)*be;return c9(bP+ce),c9(bQ+(c6>=0 and cf or-cf))end;local cg,ch,ci,cj=cb(c8)for cc=c8+c4-1,c8+360,c4 do ci,cj=cb(cc)bA(cg,ch,ci,cj,bB)cg,ch=ci,cj end end;local function ck(S,T,U,V,ar,as,au)bA(S,T,U,V,function(N,O)b8(N,O,ar,as,au)end)end;local function cl(bP,bQ,bR,bS,ar,as,au)bO(bP,bQ,bR,bS,function(N,O)b8(N,O,ar,as,au)end)end;local function cm(bP,bQ,bR,bS,ar,as,c3,au)c2(bP,bQ,bR,bS,c3,function(N,O)b8(N,O,ar,as,au)end)end;local function cn(N,O,co,cp,a6)if O>=n and O<=o then local cq,bg=1,d*(O-1)+N;for cq=1,K(cp)do if N>=l and N<=m then if a6 then j[bg]=J(i[bg],co,a6)else j[bg]=co end;k[bg]=L(cp,cq,cq)end;N,bg=N+1,bg+1 end end end;local function cr(N,O,aq,cs)local bx,ct,by,ba=aq[1],aq[2],3;local cu,cv=bx,ct;if N<l then ba=l-N;cu,N,by=cu-ba,l,by+ba*4 end;ba=N+cu-1;if ba>m then cu=cu-ba+m end;if O<n then ba=n-O;cv,O,by=cv-ba,n,by+ba*bx*4 end;ba=O+cv-1;if ba>o then cv=cv-ba+o end;local bg,cw,cx,ar,as,at,au=d*(O-1)+N,d-cu,(bx-cu)*4;for bc=1,cv do for ah=1,cu do at,au=aq[by+2],aq[by+3]if at==0 then i[bg],j[bg]=aq[by],aq[by+1]elseif at>0 and at<1 then i[bg]=J(i[bg],aq[by],at)if cs then j[bg]=J(j[bg],aq[by+1],at)else j[bg]=aq[by+1]end elseif au~=" "then j[bg]=aq[by+1]end;k[bg]=au;bg,by=bg+1,by+4 end;bg,by=bg+cw,by+cx end end;local function cy(N,O,aL,aM,bf)local cz,cA,U="┌"..string.rep("─",aL-2).."┐","└"..string.rep("─",aL-2).."┘",N+aL-1;cn(N,O,bf,cz)O=O+1;for ah=1,aM-2 do cn(N,O,bf,"│")cn(U,O,bf,"│")O=O+1 end;cn(N,O,bf,cA)end;local function cB(av,bf,cC)local cD,cE,cF="▀","▄"," "local ar,as,au=i[av],j[av],k[av]if cC then if au==cD then if bf==as then i[av],j[av],k[av]=bf,as,cF else i[av],j[av],k[av]=bf,as,au end elseif au==cF then if bf~=ar then i[av],j[av],k[av]=ar,bf,cE end else i[av],j[av],k[av]=ar,bf,cE end else if au==cE then if bf==as then i[av],j[av],k[av]=bf,as,cF else i[av],j[av],k[av]=bf,as,au end elseif au==cF then if bf~=ar then i[av],j[av],k[av]=ar,bf,cD end else i[av],j[av],k[av]=ar,bf,cD end end end;local function cG(N,O,bf)local cH=z(O/2)if N>=l and cH>=n and N<=m and cH<=o then cB(d*(cH-1)+N,bf,O%2==0)end end;local function cI(N,O,aL,aM,bf)local av,cJ,cK,cL,cM=d*(z(O/2)-1)+N,d-aL,aL;for cN=O,O+aM-1 do cL=z(cN/2)if cL>=n and cL<=o then cM=cN%2==0;for cO=N,N+aL-1 do if cO>=l and cO<=m then cB(av,bf,cM)end;av=av+1 end else av=av+aL end;if cM then av=av+cJ else av=av-cK end end end;local function cP(S,T,U,V,bf)bA(S,T,U,V,function(N,O)cG(N,O,bf)end)end;local function cQ(bP,bQ,bR,bS,bf)bO(bP,bQ,bR,bS,function(N,O)cG(N,O,bf)end)end;local function cR(cS,cT,cU)return{x=cS.x+(cT.x-cS.x)*cU,y=cS.y+(cT.y-cS.y)*cU}end;local function cV(cW,cU)local cX={}for cY=1,#cW-1 do F(cX,cR(cW[cY],cW[cY+1],cU))end;return cX end;local function cZ(cW,cU)if#cW>1 then return cZ(cV(cW,cU),cU)else return cW[1]end end;local function c_(cW,bf,d0)local d1={}for cU=0,1,d0 or 0.01 do F(d1,cZ(cW,cU))end;for cY=1,#d1-1 do cP(A(d1[cY].x),A(d1[cY].y),A(d1[cY+1].x),A(d1[cY+1].y),bf)end end;local function d2(d3)local av,bb,d4=d*(n-1)+l,d-m+l-1,{}local N,d5,d6,d7,cq,aC;local d8,d9,da,db,dc;local dd;for O=n,o do N=l;while N<=m do if f[av]~=i[av]or g[av]~=j[av]or h[av]~=k[av]or d3 then d8,d9,da=i[av],j[av],k[av]f[av]=d8;g[av]=d9;h[av]=da;d5,d6,d7,cq={da},2,N+1,av+1;while d7<=m do if d8==i[cq]and(k[cq]==" "or d9==j[cq])then f[cq]=i[cq]g[cq]=j[cq]h[cq]=k[cq]d5[d6],d6=h[cq],d6+1 else break end;d7,cq=d7+1,cq+1 end;db=d4[d8]or{}d4[d8]=db;dc=db[d9]or{index=1}db[d9]=dc;dd=dc.index;dc[dd],dd=N,dd+1;dc[dd],dd=O,dd+1;dc[dd],dd=G(d5),dd+1;N,av,dc.index=N+d6-2,av+d6-2,dd end;N,av=N+1,av+1 end;av=av+bb end;for ar,de in pairs(d4)do u(ar)for as,df in pairs(de)do if aC~=as then v(as)aC=as end;for ah=1,#df,3 do x(df[ah],df[ah+1],df[ah+2])end end end;d4=nil end;return{loadImage=aF,getIndex=M,setDrawLimit=R,resetDrawLimit=W,getDrawLimit=X,flush=aK,setResolution=aN,bind=aR,setGPUProxy=aX,getGPUProxy=aV,getScaledResolution=aZ,getResolution=aO,getWidth=aP,getHeight=aQ,getCurrentFrameTables=P,getNewFrameTables=Q,rawSet=b5,rawGet=b6,get=b7,set=b8,clear=br,copy=bs,paste=bu,rasterizeLine=bA,rasterizeEllipse=bO,rasterizePolygon=c2,semiPixelRawSet=cB,semiPixelSet=cG,update=d2,drawRectangle=b9,drawLine=ck,drawEllipse=cl,drawPolygon=cm,drawText=cn,drawImage=cr,drawFrame=cy,blur=bd,drawSemiPixelRectangle=cI,drawSemiPixelLine=cP,drawSemiPixelEllipse=cQ,drawSemiPixelCurve=c_}